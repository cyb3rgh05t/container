## This file is automatically generated (based on release.json)
##
## Do not changes any lines here
##
####################################
# All rights reserved.              #
# started from Zero                 #
# Docker owned dockserver           #
# Docker Maintainer dockserver      #
#####################################
#####################################
# THIS DOCKER IS UNDER LICENSE      #
# NO CUSTOMIZING IS ALLOWED         #
# NO REBRANDING IS ALLOWED          #
# NO CODE MIRRORING IS ALLOWED      #
#####################################
# shellcheck disable=SC2086
# shellcheck disable=SC2046
FROM node:17-bullseye-slim AS build
LABEL org.opencontainers.image.source="https://github.com/dockserver/container"

ARG TARGETPLATFORM
ARG BUILDPLATFORM
ARG VERSION="3.0.7"

RUN apt-get update -y && apt-get upgrade -y && \
    apt-get install -y --no-install-recommends ca-certificates p7zip-full git && \
    apt-get autoremove -yqq && apt-get clean -yqq && \
     rm -rf /var/lib/apt/lists/* && \
    git -c advice.detachedHead=false clone --depth 1 --branch ${VERSION} \
        https://github.com/anidl/multi-downloader-nx.git && \
    cd /multi-downloader-nx && \
    npm ci && \
    npm install -g npm@8.12.1 && \
    npm run build-ubuntu-cli && \
    BUILD=lib/_builds/multi-downloader-nx-${VERSION}-linux64 &&  \
    mkdir /build && \
    cp $BUILD/aniDL /build && \
    cp -r $BUILD/config /build

FROM debian:bullseye-slim

RUN apt-get update -y && apt-get upgrade -y && \
    apt-get install -y --no-install-recommends ffmpeg mkvtoolnix && \
     apt-get autoremove -yqq && apt-get clean -yqq && \
     rm -rf /var/lib/apt/lists/*

COPY --from=build build/* ./

VOLUME /config
VOLUME /videos

COPY ./apps/docker-crunchydl/entrypoint.sh /entrypoint.sh
ENTRYPOINT ["/bin/bash", "/entrypoint.sh"]
##EOF
