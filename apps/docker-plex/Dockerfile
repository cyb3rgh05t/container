## This file is automatically generated (based on release.json)
##
## Do not changes any lines here
##
####################################
# All rights reserved.              #
# started from Zero                 #
# Docker owned dockserver           #
# Docker Maintainer dockserver      #
#####################################
#####################################
# THIS DOCKER IS UNDER LICENSE      #
# NO CUSTOMIZING IS ALLOWED         #
# NO REBRANDING IS ALLOWED          #
# NO CODE MIRRORING IS ALLOWED      #
#####################################
# shellcheck disable=SC2086
# shellcheck disable=SC2046
LABEL org.opencontainers.image.source https://github.com/dockserver/container
FROM ghcr.io/linuxserver/baseimage-ubuntu:focal

ARG TARGETPLATFORM
ARG BUILDPLATFORM
ARG VERSION="1.25.8.5663-e071c3d62"
ARG BRANCH="master"

ENV NVIDIA_DRIVER_CAPABILITIES="compute,video,utility" \
    DEBIAN_FRONTEND="noninteractive" \
    PLEX_DOWNLOAD="https://downloads.plex.tv/plex-media-server-new" \
    PLEX_MEDIA_SERVER_APPLICATION_SUPPORT_DIR="/config/Library/Application Support" \
    PLEX_MEDIA_SERVER_HOME="/usr/lib/plexmediaserver" \
    PLEX_MEDIA_SERVER_MAX_PLUGIN_PROCS="6" \
    PLEX_MEDIA_SERVER_USER="abc" \
    PLEX_MEDIA_SERVER_INFO_VENDOR="Docker" \
    PLEX_MEDIA_SERVER_INFO_DEVICE="Docker Container"

RUN \
   case $TARGETPLATFORM in \
    'linux/amd64') \
     echo "**** add Intel repo ****" && \
         curl -sL https://repositories.intel.com/graphics/intel-graphics.key | apt-key add - && \
      echo "deb [arch=amd64] https://repositories.intel.com/graphics/ubuntu focal main" > /etc/apt/sources.list.d/intel.list && \
      export ARCH=amd64 && \
      echo "**** install runtime packages ****" && \
         apt-get update -yqq && \
      echo "**** install Intel packages ****" && \
         apt-get install --no-install-recommends -yqq intel-opencl-icd i965-va-driver gpg-agent libmfx1 ocl-icd-libopencl1; \
    ;; \
    'linux/arm64') export ARCH=arm64 && unset NVIDIA_DRIVER_CAPABILITIES ;; \
   esac \
   && \
   echo "**** install runtime packages ****" && \
     apt-get update -yqq && \
   echo "**** install packages ****" && \
     apt-get install --no-install-recommends -yqq aria2 uuid-runtime udev jq wget curl unzip unrar gpg-agent software-properties-common && \
   echo "**** install plex ****" && \
     aria2c -d /tmp -o plex.deb "https://downloads.plex.tv/plex-media-server-new/${VERSION}/debian/plexmediaserver_${VERSION}_${ARCH}.deb" && \
     dpkg -i --force-confold /tmp/plex.deb && \
   echo "**** set permissions ****" && \
     usermod -d /app abc && \
  echo "**** cleanup ****" && \
     apt-get remove -yqq aria2 jq software-properties-common gpg-agent && \
   apt-get autoremove -yqq && apt-get clean -yqq && \
   rm -rf /etc/default/plexmediaserver /tmp/* /var/lib/apt/lists/* /var/tmp/

COPY --chown=abc ./apps/docker-plex/root/ /

EXPOSE 32400

VOLUME /config
##EOF
