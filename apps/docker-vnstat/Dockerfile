## This file is automatically generated (based on release.json)
##
## Do not changes any lines here
##
####################################
# All rights reserved.              #
# started from Zero                 #
# Docker owned dockserver           #
# Docker Maintainer dockserver      #
#####################################
#####################################
# THIS DOCKER IS UNDER LICENSE      #
# NO CUSTOMIZING IS ALLOWED         #
# NO REBRANDING IS ALLOWED          #
# NO CODE MIRRORING IS ALLOWED      #
#####################################
# shellcheck disable=SC2086
# shellcheck disable=SC2046
FROM alpine:latest AS base
LABEL org.opencontainers.image.source="https://github.com/dockserver/container"

ENV HTTP_PORT=8685
ENV HTTP_BIND=*
ENV HTTP_LOG=/dev/stdout
ENV LARGE_FONTS=0
ENV CACHE_TIME=1
ENV RATE_UNIT=1
ENV PAGE_REFRESH=0
ENV RUN_VNSTATD=1

RUN true \
    && set -ex \
    && apk add --no-cache \
        gd \
        perl \
        lighttpd \
        sqlite-libs \
        curl

FROM alpine:latest AS builder

RUN true \
    && set -ex \
    && apk add --no-cache gcc make musl-dev linux-headers gd-dev sqlite-dev git \
    && git clone --depth 1 https://github.com/vergoh/vnstat \
    && cd vnstat \
    && ./configure --prefix=/usr --sysconfdir=/etc \
    && make \
    && make install

FROM base AS runtime

COPY --from=builder /usr/bin/vnstat /usr/bin/vnstat
COPY --from=builder /usr/bin/vnstati /usr/bin/vnstati
COPY --from=builder /usr/sbin/vnstatd /usr/sbin/vnstatd
COPY --from=builder /etc/vnstat.conf /etc/vnstat.conf
COPY --from=builder vnstat/examples/vnstat.cgi /var/www/localhost/htdocs/index.cgi
COPY --from=builder vnstat/examples/vnstat-json.cgi /var/www/localhost/htdocs/json.cgi

RUN true \
    && set -ex \
    && addgroup -S vnstat  \
    && adduser -S -h /var/lib/vnstat -s /sbin/nologin -g vnStat -D -H -G vnstat vnstat

VOLUME /var/lib/vnstat
EXPOSE ${HTTP_PORT}

COPY ./apps/docker-vnstat/root/favicon.ico /var/www/localhost/htdocs/favicon.ico
COPY ./apps/docker-vnstat/root/start.sh /start.sh

RUN chmod 777 /start.sh

CMD [ "/start.sh" ]
##EOF
